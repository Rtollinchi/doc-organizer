<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Doc Organizer</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: -apple-system, sans-serif;
        background: #1a1a2e;
        color: #eee;
        min-height: 100vh;
        padding: 1.5rem;
      }
      .header {
        text-align: center;
        margin-bottom: 1.5rem;
      }
      .header h1 {
        color: #e94560;
        font-size: 1.4rem;
      }
      .header p {
        color: #666;
        font-size: 0.8rem;
        margin-top: 0.3rem;
      }

      /* Drop zone */
      .dropzone {
        border: 2px dashed #333;
        border-radius: 8px;
        padding: 2.5rem;
        text-align: center;
        cursor: pointer;
        transition: border-color 0.2s;
        max-width: 700px;
        margin: 0 auto;
      }
      .dropzone:hover,
      .dropzone.active {
        border-color: #e94560;
      }
      .dropzone p {
        color: #888;
      }
      .dropzone input {
        display: none;
      }

      /* Progress */
      .progress {
        text-align: center;
        padding: 2rem;
        max-width: 700px;
        margin: 0 auto;
      }
      .progress .bar-bg {
        height: 6px;
        background: #333;
        border-radius: 3px;
        margin-top: 1rem;
        overflow: hidden;
      }
      .progress .bar {
        height: 100%;
        background: #4ecca3;
        transition: width 0.3s;
        border-radius: 3px;
      }
      .progress .status {
        color: #888;
        font-size: 0.85rem;
        margin-top: 0.5rem;
      }

      /* Batch table */
      .batch {
        max-width: 900px;
        margin: 0 auto;
        display: none;
      }
      .batch.visible {
        display: block;
      }
      .batch-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }
      .batch-header h2 {
        font-size: 1.1rem;
        color: #ccc;
      }
      .batch-stats {
        font-size: 0.8rem;
        color: #888;
      }

      .doc-card {
        background: #16213e;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.8rem;
        border-left: 4px solid #333;
      }
      .doc-card.high {
        border-left-color: #4ecca3;
      }
      .doc-card.low {
        border-left-color: #e94560;
      }
      .doc-card .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.8rem;
      }
      .doc-card .original {
        font-size: 0.75rem;
        color: #666;
        word-break: break-all;
      }
      .doc-card .badge {
        font-size: 0.65rem;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: bold;
      }
      .badge.high {
        background: #4ecca3;
        color: #000;
      }
      .badge.low {
        background: #e94560;
        color: #fff;
      }

      .card-fields {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
      }
      .card-fields.full {
        grid-template-columns: 1fr;
      }
      .card-field label {
        font-size: 0.7rem;
        color: #888;
        display: block;
      }
      .card-field select,
      .card-field input {
        width: 100%;
        padding: 0.4rem;
        border: 1px solid #333;
        border-radius: 4px;
        background: #0f3460;
        color: #eee;
        font-size: 0.85rem;
      }
      .card-field select:focus,
      .card-field input:focus {
        outline: none;
        border-color: #e94560;
      }

      .card-preview {
        margin-top: 0.6rem;
        padding: 0.5rem;
        background: #0a2647;
        border-radius: 4px;
        font-size: 0.75rem;
        color: #4ecca3;
        word-break: break-all;
      }

      /* Buttons */
      .actions {
        text-align: center;
        margin-top: 1.5rem;
      }
      button {
        padding: 0.7rem 2rem;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        font-size: 1rem;
        cursor: pointer;
        margin: 0 0.5rem;
      }
      button.confirm {
        background: #4ecca3;
        color: #000;
      }
      button.confirm:hover {
        background: #3db890;
      }
      button.cancel {
        background: #333;
        color: #aaa;
      }
      button.cancel:hover {
        background: #444;
      }

      /* Results */
      .results {
        max-width: 700px;
        margin: 1.5rem auto 0;
        display: none;
      }
      .results.visible {
        display: block;
      }
      .results h2 {
        color: #4ecca3;
        text-align: center;
        margin-bottom: 1rem;
      }
      .result-item {
        padding: 0.5rem;
        border-bottom: 1px solid #222;
        font-size: 0.85rem;
      }
      .result-item.success {
        color: #4ecca3;
      }
      .result-item.fail {
        color: #e94560;
      }
      .reset-link {
        display: block;
        text-align: center;
        margin-top: 1.5rem;
        color: #e94560;
        cursor: pointer;
        font-size: 0.85rem;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>üìÑ Doc Organizer</h1>
      <p>Drop your scanned documents ‚Äî the tool reads and organizes them</p>
      <p id="modeIndicator" style="color: #4ecca3; font-size: 0.75rem; margin-top: 0.3rem"></p>
    </div>

    <!-- Step 1: Drop files -->
    <div class="dropzone" id="dropzone">
      <p>üìé Drop files here or click to select</p>
      <input type="file" id="fileInput" multiple accept="image/*,.pdf" />
    </div>
    <div style="max-width: 700px; margin: 0.6rem auto 0; text-align: center">
      <label style="color: #888; font-size: 0.8rem; cursor: pointer">
        <input
          type="checkbox"
          id="multipageToggle"
          style="margin-right: 0.4rem; vertical-align: middle"
        />
        üìÑ Multi-page mode ‚Äî treat all dropped files as pages of the same
        document
      </label>
    </div>

    <!-- Multi-page staging area -->
    <div
      id="pageStaging"
      style="display: none; max-width: 700px; margin: 1rem auto 0"
    >
      <div style="background: #16213e; border-radius: 8px; padding: 1rem">
        <h3 style="color: #4ecca3; font-size: 0.95rem; margin-bottom: 0.6rem">
          üìÑ Pages queued:
        </h3>
        <div id="pageList" style="margin-bottom: 0.8rem"></div>
        <div style="display: flex; gap: 0.5rem; justify-content: center">
          <button
            class="cancel"
            id="addMoreBtn"
            style="font-size: 0.85rem; padding: 0.5rem 1.2rem"
          >
            + Add more pages
          </button>
          <button
            class="confirm"
            id="scanAllBtn"
            style="font-size: 0.85rem; padding: 0.5rem 1.2rem"
          >
            üîç Scan All Pages
          </button>
        </div>
      </div>
    </div>

    <!-- Step 2: Processing -->
    <div class="progress" id="progress" style="display: none">
      <p>üîç Reading <span id="progressTotal">0</span> documents...</p>
      <div class="bar-bg">
        <div class="bar" id="progressBar" style="width: 0%"></div>
      </div>
      <p class="status" id="progressStatus">Uploading and scanning...</p>
    </div>

    <!-- Step 3: Review batch -->
    <div class="batch" id="batch">
      <div class="batch-header">
        <h2>Review Documents</h2>
        <span class="batch-stats" id="batchStats"></span>
      </div>
      <div id="cardList"></div>
      <div class="actions">
        <button class="cancel" id="cancelBtn">Cancel</button>
        <button class="confirm" id="confirmAllBtn">‚úÖ Confirm All</button>
      </div>
    </div>

    <!-- Step 4: Results -->
    <div class="results" id="results">
      <h2>‚úÖ Batch Complete</h2>
      <div id="resultList"></div>
      <span class="reset-link" id="resetLink">+ Organize more documents</span>
    </div>

    <script>
      let batchData = [];
      let vendors = [];
      let docTypes = [];
      let pageQueue = []; // files staged for multi-page mode
      let analysisMode = "ocr"; // "llm" or "ocr"

      // Check analysis mode on load
      fetch("/api/mode")
        .then((r) => r.json())
        .then((data) => {
          analysisMode = data.mode;
          const indicator = document.getElementById("modeIndicator");
          if (data.mode === "llm") {
            indicator.textContent = "üß† LLM Vision mode (Ollama)";
          } else {
            indicator.textContent = "üìù OCR mode (Tesseract)";
            indicator.style.color = "#888";
          }
        })
        .catch(() => {});

      // --- Drop zone ---
      const dropzone = document.getElementById("dropzone");
      const fileInput = document.getElementById("fileInput");

      dropzone.addEventListener("click", () => fileInput.click());
      dropzone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropzone.classList.add("active");
      });
      dropzone.addEventListener("dragleave", () =>
        dropzone.classList.remove("active"),
      );
      dropzone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropzone.classList.remove("active");
        if (e.dataTransfer.files.length) onFilesAdded(e.dataTransfer.files);
      });
      fileInput.addEventListener("change", () => {
        if (fileInput.files.length) onFilesAdded(fileInput.files);
      });

      // --- Multi-page staging ---
      function onFilesAdded(fileList) {
        const files = Array.from(fileList);
        const multipage = document.getElementById("multipageToggle").checked;

        if (!multipage) {
          // Normal batch mode ‚Äî process immediately
          uploadAndAnalyze(files, false);
          return;
        }

        // Multi-page mode ‚Äî add to queue, show staging area
        pageQueue.push(...files);
        renderPageQueue();
      }

      function renderPageQueue() {
        const staging = document.getElementById("pageStaging");
        const list = document.getElementById("pageList");
        staging.style.display = "block";

        list.innerHTML = pageQueue
          .map(
            (f, idx) =>
              '<div style="display:flex;justify-content:space-between;align-items:center;padding:0.3rem 0.5rem;background:#0f3460;border-radius:4px;margin-bottom:0.3rem;font-size:0.8rem;">' +
              '<span style="color:#ccc;">üìÑ Page ' +
              (idx + 1) +
              ": " +
              f.name +
              "</span>" +
              '<span style="color:#e94560;cursor:pointer;font-size:0.7rem;" onclick="removeFromQueue(' +
              idx +
              ')">‚úï remove</span>' +
              "</div>",
          )
          .join("");
      }

      function removeFromQueue(idx) {
        pageQueue.splice(idx, 1);
        if (pageQueue.length === 0) {
          document.getElementById("pageStaging").style.display = "none";
        } else {
          renderPageQueue();
        }
      }

      // "Add more pages" ‚Äî re-open file picker
      document.getElementById("addMoreBtn").addEventListener("click", () => {
        fileInput.click();
      });

      // "Scan All Pages" ‚Äî send the queued files
      document.getElementById("scanAllBtn").addEventListener("click", () => {
        if (!pageQueue.length) return;
        const files = [...pageQueue];
        pageQueue = [];
        document.getElementById("pageStaging").style.display = "none";
        uploadAndAnalyze(files, true);
      });

      // --- Upload + Analyze ---
      async function uploadAndAnalyze(files, multipage) {
        dropzone.style.display = "none";
        document.getElementById("pageStaging").style.display = "none";

        const progressEl = document.getElementById("progress");
        progressEl.style.display = "block";
        document.getElementById("progressTotal").textContent = multipage
          ? files.length + " page(s)"
          : files.length;
        document.getElementById("progressBar").style.width = "30%";
        document.getElementById("progressStatus").textContent =
          analysisMode === "llm"
            ? "Analyzing with LLM vision ‚Äî this may take 30-60s per document..."
            : "Uploading and scanning...";

        const form = new FormData();
        files.forEach((f) => form.append("files", f));

        const endpoint = multipage
          ? "/api/analyze-multipage"
          : "/api/analyze-batch";

        try {
          const res = await fetch(endpoint, {
            method: "POST",
            body: form,
          });
          const data = await res.json();

          document.getElementById("progressBar").style.width = "100%";

          if (data.error) {
            document.getElementById("progressStatus").textContent =
              "Error: " + data.error;
            return;
          }

          batchData = data.results;
          vendors = data.vendors;
          docTypes = data.docTypes;

          setTimeout(() => {
            progressEl.style.display = "none";
            renderBatch();
          }, 500);
        } catch (err) {
          document.getElementById("progressStatus").textContent =
            "Upload failed.";
        }
      }

      // --- Render Review Cards ---
      function renderBatch() {
        const container = document.getElementById("cardList");
        container.innerHTML = "";

        let highCount = 0;
        let lowCount = 0;

        batchData.forEach((item, i) => {
          if (!item.analysis) return;
          const a = item.analysis;

          const overallConfidence =
            a.vendor.confidence === "high" && a.docType.confidence === "high"
              ? "high"
              : "low";
          if (overallConfidence === "high") highCount++;
          else lowCount++;

          const card = document.createElement("div");
          card.className = `doc-card ${overallConfidence}`;
          card.innerHTML = `
          <div class="card-header">
            <span class="original">${item.originalName}</span>
            <span class="badge ${overallConfidence}">${overallConfidence === "high" ? "‚úÖ Ready" : "‚ö†Ô∏è Needs Review"}</span>
          </div>
          <div class="card-fields">
            <div class="card-field">
              <label for="vendor-${i}">Vendor</label>
              <select id="vendor-${i}">
                <option value="">-- Select --</option>
                ${vendors.map((v) => `<option value="${v}" ${v === a.vendor.value ? "selected" : ""}>${v.replace(/_/g, " ")}</option>`).join("")}
              </select>
            </div>
            <div class="card-field">
              <label for="docType-${i}">Doc Type</label>
              <select id="docType-${i}">
                <option value="">-- Select --</option>
                ${docTypes.map((d) => `<option value="${d}" ${d === a.docType.value ? "selected" : ""}>${d.replace(/_/g, " ")}</option>`).join("")}
              </select>
            </div>
            <div class="card-field">
              <label for="date-${i}">Date</label>
              <input id="date-${i}" value="${a.date.value}" />
            </div>
            <div class="card-field">
              <label for="desc-${i}">Description</label>
              <input id="desc-${i}" value="${a.description ? a.description.value || "" : ""}" placeholder="e.g. Hex Bolts for Pump Rebuild" />
            </div>
            <div class="card-field">
              <label for="reqBy-${i}">Requested By (optional)</label>
              <input id="reqBy-${i}" placeholder="e.g. Mike, Sean" />
            </div>
            <div class="card-field">
              <label for="part-${i}">Part # (optional)</label>
              <input id="part-${i}" value="${a.partNumber.value || ""}" />
            </div>
            <div class="card-field">
              <label for="po-${i}">PO # (optional)</label>
              <input id="po-${i}" value="${a.poNumber.value || ""}" />
            </div>
          </div>
          <div class="card-fields full">
            <div class="card-preview" id="preview-${i}"></div>
          </div>
        `;
          container.appendChild(card);

          // Live preview updates
          const updatePreview = () => {
            const parts = [
              document.getElementById("date-" + i).value,
              document.getElementById("vendor-" + i).value,
            ];
            const desc = document.getElementById("desc-" + i).value;
            const reqBy = document.getElementById("reqBy-" + i).value;
            const part = document.getElementById("part-" + i).value;
            const po = document.getElementById("po-" + i).value;
            if (desc) parts.push(desc);
            if (reqBy) parts.push("For " + reqBy);
            if (part) parts.push(part);
            if (po) parts.push(po);

            const ext = item.originalName.substring(
              item.originalName.lastIndexOf("."),
            );
            const dt = document.getElementById("docType-" + i).value;
            const v = document.getElementById("vendor-" + i).value;
            const folder = dt === "Packing_Slips" ? "Packing_Slips_" + v : dt;
            document.getElementById("preview-" + i).textContent =
              "‚Üí " + folder + "/" + parts.join(" - ") + ext;
          };

          ["vendor", "docType", "date", "desc", "reqBy", "part", "po"].forEach(
            (field) => {
              const el = document.getElementById(field + "-" + i);
              el.addEventListener("input", updatePreview);
              el.addEventListener("change", updatePreview);
            },
          );

          updatePreview();
        });

        document.getElementById("batchStats").textContent =
          highCount +
          " ready, " +
          lowCount +
          " need review ‚Äî " +
          batchData.length +
          " total";
        document.getElementById("batch").classList.add("visible");
      }

      // --- Confirm All ---
      document
        .getElementById("confirmAllBtn")
        .addEventListener("click", async () => {
          const items = batchData.map((item, i) => ({
            tempFile: item.tempFile,
            tempFiles: item.tempFiles || [item.tempFile],
            originalName: item.originalName,
            vendor: document.getElementById("vendor-" + i).value,
            docType: document.getElementById("docType-" + i).value,
            date: document.getElementById("date-" + i).value,
            description: document.getElementById("desc-" + i).value,
            requestedBy: document.getElementById("reqBy-" + i).value,
            partNumber: document.getElementById("part-" + i).value,
            poNumber: document.getElementById("po-" + i).value,
          }));

          const missing = items.filter((it) => !it.vendor || !it.docType);
          if (missing.length) {
            alert(
              missing.length +
                " document(s) are missing Vendor or Doc Type. Please review.",
            );
            return;
          }

          try {
            const res = await fetch("/api/confirm-batch", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ items }),
            });
            const data = await res.json();

            document.getElementById("batch").classList.remove("visible");

            const resultList = document.getElementById("resultList");
            resultList.innerHTML = data.results
              .map(
                (r) =>
                  '<div class="result-item ' +
                  (r.success ? "success" : "fail") +
                  '">' +
                  (r.success ? "‚úÖ" : "‚ùå") +
                  " " +
                  r.originalName +
                  " ‚Üí " +
                  (r.newName || "failed") +
                  "</div>",
              )
              .join("");

            document.getElementById("results").classList.add("visible");
          } catch {
            alert("Failed to process batch.");
          }
        });

      document
        .getElementById("cancelBtn")
        .addEventListener("click", () => location.reload());
      document
        .getElementById("resetLink")
        .addEventListener("click", () => location.reload());
    </script>
  </body>
</html>
